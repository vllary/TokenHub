import requests
import pandas as pd
import matplotlib.pyplot as plt

class TokenHub:
    def __init__(self, api_key: str):
        self.api_url = 'https://api.etherscan.io/api'
        self.api_key = api_key

    def get_token_balance(self, address: str, contract_address: str) -> dict:
        params = {
            'module': 'account',
            'action': 'tokenbalance',
            'contractaddress': contract_address,
            'address': address,
            'tag': 'latest',
            'apikey': self.api_key
        }
        response = requests.get(self.api_url, params=params)
        data = response.json()
        return data

    def get_token_transactions(self, address: str, contract_address: str) -> pd.DataFrame:
        params = {
            'module': 'account',
            'action': 'tokentx',
            'contractaddress': contract_address,
            'address': address,
            'page': 1,
            'offset': 100,
            'sort': 'asc',
            'apikey': self.api_key
        }
        response = requests.get(self.api_url, params=params)
        data = response.json()
        if 'result' in data:
            df = pd.DataFrame(data['result'])
            df['value'] = df['value'].astype(float) / (10 ** 18)  # Adjust for token decimals
            df['timeStamp'] = pd.to_datetime(df['timeStamp'], unit='s')
            return df
        else:
            return pd.DataFrame()

    def plot_token_transactions(self, address: str, contract_address: str):
        df = self.get_token_transactions(address, contract_address)
        if df.empty:
            print("No transaction data found.")
            return

        plt.figure(figsize=(12, 6))
        plt.plot(df['timeStamp'], df['value'], marker='o', linestyle='-')
        plt.title(f'Token Transactions for Address {address}')
        plt.xlabel('Date')
        plt.ylabel('Token Amount')
        plt.grid(True)
        plt.show()

# Example Usage
if __name__ == "__main__":
    ETHERSCAN_API_KEY = 'YOUR_ETHERSCAN_API_KEY'
    ADDRESS = '0xYourWalletAddress'  # Replace with the wallet address
    CONTRACT_ADDRESS = '0xYourTokenContractAddress'  # Replace with the token contract address

    token_hub = TokenHub(api_key=ETHERSCAN_API_KEY)

    # Fetch and Display Token Balance
    balance = token_hub.get_token_balance(ADDRESS, CONTRACT_ADDRESS)
    print(f"Token Balance for {ADDRESS}:")
    print(balance)

    # Plot Token Transactions
    token_hub.plot_token_transactions(ADDRESS, CONTRACT_ADDRESS)
